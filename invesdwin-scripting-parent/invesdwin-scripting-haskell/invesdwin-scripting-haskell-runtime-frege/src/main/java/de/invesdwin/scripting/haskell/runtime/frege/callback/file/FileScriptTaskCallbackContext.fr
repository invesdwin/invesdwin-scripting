import Data.JSON

waitForFile :: File -> IO ()
waitForFile file = do
  exists <- file.exists
  if exists
     then pure ()
     else do
       Thread.sleep 1
       waitForFile file

callback :: String -> [String] -> IO String
callback method args = do
  let scriptTaskCallbackContextRequestPartFile = {SCRIPT_TASK_CALLBACK_CONTEXT_REQUEST_PART_FILE}
  let scriptTaskCallbackContextRequestFile = {SCRIPT_TASK_CALLBACK_CONTEXT_REQUEST_FILE}
  let scriptTaskCallbackContextResponseFile = {SCRIPT_TASK_CALLBACK_CONTEXT_RESPONSE_FILE}
  let message = method ++ ";" ++ show (toJSON args)

  writeFile scriptTaskCallbackContextRequestPartFile message

  let requestPartFile = File.new scriptTaskCallbackContextRequestPartFile
  let requestFile     = File.new scriptTaskCallbackContextRequestFile
  requestPartFile.renameTo requestFile

  let responseFile = File.new scriptTaskCallbackContextResponseFile
  waitForFile responseFile

  returnExpression <- readFile scriptTaskCallbackContextResponseFile
  responseFile.delete

  putStrLn "****************************************** +++"
  putStrLn returnExpression
  -- TODO eval
  putStrLn "****************************************** ---"
  pure returnExpression

callbackIO :: String -> [IO String] -> IO String
callbackIO method ioArgs = do
  args <- sequence ioArgs      -- args :: [String]
  callback method args
